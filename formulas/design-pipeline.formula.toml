description = "Multi-phase design workflow with parallel review convoy. Progresses from research through drafting, multi-angle review, and human-gated synthesis. Dispatch with: gt sling <bead> <rig> --no-merge"
formula = "design-pipeline"
type = "workflow"
version = 1

[[steps]]
id = "research"
title = "Research {{topic}}"
description = """Investigate the problem space per skill:research.

Setup: Create a branch named after the parent bead (git checkout -b <bead-id>). Design artifacts go in docs/designs/<bead-id>-<descriptor>.md.

Survey internal context (code, docs, beads, prior art), validate assumptions, research externally as needed. Produce a structured findings document committed to the branch. Do NOT propose solutions — map the territory."""
acceptance = "Branch created, research document committed to docs/designs/ with constraints, findings, assumptions table, prior art, and open questions"

[[steps]]
id = "draft"
title = "Draft design for {{topic}}"
needs = ["research"]
description = "Synthesize research into a design document. Propose 2-4 options with tradeoffs. Include a recommendation with justification. Address open questions from research where possible; flag remaining unknowns. Commit the design doc to the branch and update the bead design field: bd update <issue> --design \"<summary>\""
acceptance = "Design document committed with options, tradeoffs, recommendation, and unknowns flagged"

[[steps]]
id = "dispatch-reviews"
title = "Dispatch review convoy for {{topic}}"
needs = ["draft"]
description = """Spawn child beads for parallel document review. Each child bead gets a different review lens per skill:document-review. Minimum lenses: feasibility, adversarial, completeness. Additional lenses based on topic (security, user-impact, cost, etc.).

Create child beads:
  bd create -t task "Review {{topic}} design: [lens]" --parent <this-bead>

Dispatch via convoy:
  gt convoy create <child-bead-ids> --subject "{{topic}} review convoy"
  gt sling <child-bead> <rig> --no-merge  (for each child)

Each reviewer commits their review to the same branch. Wait for all reviews to complete."""
acceptance = "Review child beads created, dispatched as convoy, all reviews committed to branch"

[[steps]]
id = "synthesize"
title = "Synthesize reviews for {{topic}}"
needs = ["dispatch-reviews"]
description = """Read all review documents from the convoy. Produce a synthesis:

1. Consensus — what all reviewers agree on
2. Conflicts — where reviewers disagree, with both sides stated
3. Blockers — any BLOCK findings that must be resolved
4. Open questions — questions that need human judgment
5. Revised recommendation — update recommendation based on review feedback

Commit synthesis to branch. Batch all questions for the human gate — don't ask them piecemeal."""
acceptance = "Synthesis document committed with consensus, conflicts, blockers, open questions, and revised recommendation"

[[steps]]
id = "human-gate"
title = "Human review of {{topic}} design"
needs = ["synthesize"]
description = "HUMAN GATE. Present the synthesis to the human. Include: the revised recommendation, key conflicts that need resolution, and any open questions. The human may approve, request revisions (cycle back to draft), or redirect. Mail the mayor with DESIGN REVIEW summary."
acceptance = "Human has reviewed synthesis and provided direction (approve, revise, or redirect)"
gate = { type = "human" }

[[steps]]
id = "finalize"
title = "Finalize {{topic}} design"
needs = ["human-gate"]
description = """Apply human feedback. If approved: update design doc as final, close review child beads, update parent bead design field with final summary. If revisions requested: update the draft, optionally dispatch another review convoy, and cycle back through human-gate.

Deliverables:
- Final design document on branch
- Implementation beads decomposed from the design (if human approves proceeding)
- Bead design field updated with final summary"""
acceptance = "Design document finalized, implementation beads created (if approved), branch ready for merge or continued iteration"

[[steps]]
id = "retro"
title = "Retrospective: {{topic}} design pipeline"
needs = ["finalize"]
description = """Analyze this workflow execution and produce a retro document. Review:

1. Process compliance — did each step follow its skill? Were any steps rushed or skipped?
2. Artifact quality — was the research thorough? Was the design well-reasoned? Were reviews substantive or rubber-stamps?
3. Review convoy effectiveness — did the lenses produce distinct findings? Were there redundant or missing angles?
4. Rationalizations observed — any moments where the agent (or reviewers) cut corners, skipped checks, or made excuses? Capture exact rationalizations for skill improvement.
5. Cycle efficiency — what could have been parallelized? Where did the human wait unnecessarily? Where did agents wait unnecessarily?
6. Skill gaps — did any step lack a skill that would have helped? Were existing skills adequate?

File ks beads for actionable findings. Link to existing ks issues if the pattern is already tracked.
For each new rationalization observed, note which skill's rationalization table should be updated.

Commit retro document to the branch."""
acceptance = "Retro document committed with findings, ks beads filed for actionable items, rationalizations captured"

[[steps]]
id = "retro-human"
title = "Human retro checkpoint for {{topic}}"
needs = ["retro"]
description = """HUMAN GATE. Present the retro findings to the human. Include:

1. Summary of what worked and what didn't in this pipeline run
2. Proposed keeper improvements (skill updates, formula changes, new skills needed)
3. New rationalizations to add to skill tables
4. Any beads filed and their priority

The human decides which improvements to pursue. Approved improvements become keeper beads dispatched through standard-feature or the skill-improvement lifecycle (red test → draft → green test → merge)."""
acceptance = "Human has reviewed retro findings and directed which improvements to pursue"
gate = { type = "human" }

[vars]
[vars.topic]
description = "The design topic or problem to investigate"
required = true

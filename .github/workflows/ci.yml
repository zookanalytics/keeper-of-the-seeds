name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate TOML syntax
        run: |
          errors=0
          for f in formulas/*.formula.toml; do
            if ! python3 -c "import tomllib; tomllib.load(open('$f','rb'))" 2>/dev/null; then
              if ! python3 -c "import tomli; tomli.load(open('$f','rb'))" 2>/dev/null; then
                echo "FAIL: $f"
                errors=$((errors + 1))
              fi
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "$errors TOML file(s) have syntax errors"
            exit 1
          fi
          echo "All TOML files valid"

      - name: Shellcheck
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq shellcheck
          errors=0
          while IFS= read -r -d '' f; do
            echo "Checking $f"
            shellcheck "$f" || errors=$((errors + 1))
          done < <(find . -name '*.sh' -not -path './.git/*' -print0)
          if [ "$errors" -gt 0 ]; then
            echo "$errors file(s) failed shellcheck"
            exit 1
          fi

      - name: Formula structural validation
        run: |
          if command -v bd &>/dev/null; then
            bash tests/cook-all-formulas.sh
          else
            echo "bd not available in CI â€” skipping formula cook validation"
            echo "TOML syntax was validated in previous step"
          fi
